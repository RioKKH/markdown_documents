## フィーチャーブランチの取り込み方

### 新機能を開発する場合

#### 1. メインブランチからフィーチャーブランチを作成する

```bash
# メインブランチから最新の状態を取得します
$ git switch main
$ git pull

# 新しいフィーチャーブランチ("new-function")を作成します
$ git branch -m feature/new-function
```

この時点でのコミット履歴は以下の通りです：

```bash
A---B---C  (main)
         \
          (feature/new-function)
```



#### 2. フィーチャーブランチで開発を進める

```bash
# 変更を加えてコミットします (コミットDに相当)
$ git add .
$ git commit -m "Add change#1"

# さらに変更を加えてコミットします (コミットEに相当)
$ git add .
$ git commit -m "Add change#2"

# さらに変更を加えてコミットします (コミットFに相当)
$ git add .
$ git commit -m "Add change#3"
```

この時点でのコミット履歴は以下の通りです：

```bash
A---B---C  (main)
         \
          D---E---F  (feature/new-function)
```



#### 3. 並行してメインブランチも更新される

他の開発者がメインブランチに変更をマージしたために、以下のような状況に変わったとします。

```bash
A---B---C---G---H  (main)
         \
          D---E---F  (feature/new-function)
```



#### 4. フィーチャーブランチの開発が完成したらメインブランチの変更を取り込む

```bash
# 先ず最新のメインブランチを取得します
$ git switch main
$ git pull

# フィーチャーブランチに戻る
$ git switch feature/new-function

# メインブランチの変更をリベースで取り込む
$ git rebase main
```

上記リベース後のコミット履歴は以下の様になります：

```bash
A---B---C---G---H  (main)
                 \
                  D'---E'---F'  (feature/new-function)
```

> [!CAUTION]
>
> D', E', F' はリベースによって作り直されたコミットです。元のD, E, Fと同じ内容ですが、異なるコミットハッシュ値を持ちます。 

> [!Caution]
>
> `feature`ブランチのコミットが多い場合には、`main`にマージする前に==squash==を用いて整理する事を検討してください。
>
> ```bash
> # 上述の$ git rebase main に続けて以下のコマンドを実行してください
> # 最新から3つのコミット(D', E', F')を統合したい場合には、 HEAD~3 と指定して下さい
> $ git rebase -i HEAD~3
> ```
>
> インタラクティブモードでエディターが開きます。
>
> ```bash
> pick <D'のHash値>
> pick <E'のHash値>
> pick <F'のHash値>
> 
> # 省略
> ```
>
> 最初のコミット以外を ==squash==、もしくは==s==に変更します。
> 
>```bash
> pick <D'のHash値>
> squash <E'のHash値>
> squash <F'のHash値>
> 
> # 省略
> ```
> 
>保存して閉じると、コミットメッセージを編集するエディタが開きます。
> ここで3つのコミットメッセージをまとめて1つのわかりやすいメッセージになるように編集してください。



#### 5. フィーチャーブランチをメインブランチにマージする

```bash
# メインブランチに切り替えます
$ git switch main

# フィーチャーブランチをマージ（fast-forwardマージになります）
$ git merge feature/new-function
```

これによって、マージ後のコミット履歴は以下の様になります：

```bash
A---B---C---G---H---D'---E'---F'  (main, feature/new-function)
```



#### 6. ローカルのフィーチャーブランチを削除する

不要であればローカルのフィーチャーブランチを削除してください。

```bash
$ git branch -d feature/new-function
```



#### 7. リモートのフィーチャーブランチを削除する

不要であればローカルのフィーチャーブランチを削除してください。

```bash
$ git push origin --delete feature/new-function
```



### リベース時の注意点

1. コンフリクトの解消
   リベース中にコンフリクトが発生した場合は、各コミットごとに解決する必要が有ります。
   コンフリクトが解消したら以下のコマンドを実行します。
   メインブランチにマージする前に全てのコンフリクトを解決します。

   ```bash
   # コンフリクト解消後
   $ git add .
   $ git rebase --continue
   ```

2. 公開ブランチのリベース
   既にリモートにプッシュしたブランチをリベースした場合は、強制プッシュが必要になります。

   ```bash
   $ git push --force-with-lease
   ```

   `--force-with-lease`オプションは、リモートブランチが予期せず更新されていない事を確認してから強制プッシュする為、`--force`よりも安全です。

   featureブランチを用いた新機能作成においては、基本的にこのような作業が必要になることは無い筈です。もしこのような作業が必要になった場合には、一旦回りの人に確認を取って下さい。

3. リベースの原則
   公開されていない自分だけのブランチや、他の開発者と共有していないブランチのみでリベースをするのが原則です。

